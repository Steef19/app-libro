<div class="container mt-4">
  <h1>Libro</h1>
  <div class="d-flex justify-content-center mb-3">
    <button mat-raised-button color="primary" (click)="abrirModal()">
      <mat-icon>add</mat-icon>AgregarLibro
    </button>
  </div>

  <mat-form-field appearance="fill" class="w-100">
    <mat-label>Buscar</mat-label>
    <input matInput (keyup)="filtroLibro($event)" placeholder="Buscar libro" />
  </mat-form-field>

  <div class="table-responsive">
    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      class="mat-elevation-z8 w-100"
    >
      <ng-container matColumnDef="detalles">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let libro">
          <button
            mat-icon-button
            color="primary"
            (click)="abrirModalDetalles(libro)"
          >
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="idLibro">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Id</th>
        <td mat-cell *matCellDef="let l">{{ l.idLibro }}</td>
      </ng-container>

      <ng-container matColumnDef="titulo">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Titulo</th>
        <td mat-cell *matCellDef="let l">{{ l.titulo }}</td>
      </ng-container>

      <ng-container matColumnDef="editorial">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Editorial</th>
        <td mat-cell *matCellDef="let l">{{ l.editorial }}</td>
      </ng-container>

      <ng-container matColumnDef="edicion">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Edicion</th>
        <td mat-cell *matCellDef="let l">{{ l.edicion }}</td>
      </ng-container>

      <ng-container matColumnDef="idioma">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Idioma</th>
        <td mat-cell *matCellDef="let l">{{ l.idioma }}</td>
      </ng-container>

      <ng-container matColumnDef="fechaPublicacion">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          Fecha De Publicacion
        </th>
        <td mat-cell *matCellDef="let l">
          {{ l.fechaPublicacion | date : "yyyy-MM-dd" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="numEjemplares">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>N° Ejemplares</th>
        <td mat-cell *matCellDef="let l">{{ l.numEjemplares }}</td>
      </ng-container>

      <ng-container matColumnDef="precio">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
        <td mat-cell *matCellDef="let l">{{ l.precio | currency }}</td>
      </ng-container>

      <ng-container matColumnDef="autor">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Autor</th>
        <td mat-cell *matCellDef="let l">{{ nombreCompletoAutor(l.autor) }}</td>
      </ng-container>

      <ng-container matColumnDef="categoria">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoria</th>
        <td mat-cell *matCellDef="let l">{{ l.categoria?.categoria }}</td>
      </ng-container>

      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Acciones</th>
        <td mat-cell *matCellDef="let l">
          <div class="d-flex gap-1">
            <button class="btn btn-warning btn-sm me-1" (click)="abrirModal(l)">
              <mat-icon>edit</mat-icon>
            </button>
            <button class="btn btn-danger btn-sm" (click)="libro = l; delete()">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="mostrarColumnas"></tr>
      <tr mat-row *matRowDef="let row; columns: mostrarColumnas"></tr>
    </table>
    <mat-paginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons>
    </mat-paginator>
  </div>
  <ng-template #modalLibro>
    <mat-dialog-content>
      <h2 mat-dialog-title>
        {{ editar ? "Editar Libro" : "Agregar Libro" }} Libro
      </h2>
      <form #formLibro="ngForm" novalidate>
        <div class="row">
          <div class="col-md-12 mb-2">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Nombre del Libro</mat-label>
              <input
                matInput
                type="text"
                [(ngModel)]="libro.titulo"
                name="titulo"
                required
              />
            </mat-form-field>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12 mb-2">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Descripcion</mat-label>
              <input
                matInput
                type="text"
                [(ngModel)]="libro.descripcion"
                name="descripcion"
                required
              />
            </mat-form-field>
          </div>
        </div>

        <div class="col-md-4 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Editorial</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.editorial"
              name="editorial"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-4 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Idioma</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.idioma"
              name="idioma"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-4 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Fecha de Publicacion</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              [(ngModel)]="libro.fechaPublicacion"
              name="fechaPublicacion"
              required
            />
            <mat-datepicker-toggle matSuffix [for]="picker">
            </mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="col-md-3 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Numero de Paginas</mat-label>
            <input
              matInput
              type="number"
              [(ngModel)]="libro.numPaginas"
              name="numPaginas"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-3 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Edicion</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.edicion"
              name="edicion"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-3 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Tipo de Pasta</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.tipoPasta"
              name="tipoPasta"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-3 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Numero de Ejemplares</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.numEjemplares"
              name="numEjemplares"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-4 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>ISBN</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.iSBN"
              name="ISBN"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-4 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Presentacion</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="libro.presentacion"
              name="presentacion"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-4 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Precio</mat-label>
            <input
              matInput
              type="number"
              [(ngModel)]="libro.precio"
              name="precio"
              required
            />
          </mat-form-field>
        </div>

        <div class="col-md-6 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Categoria</mat-label>
            <mat-select
              [(ngModel)]="libro.categoria"
              name="categoria"
              required
              [compareWith]="compararCategorias"
            >
              <mat-option *ngFor="let c of categorias" [value]="c">{{
                c.categoria
              }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-6 mb-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Autor</mat-label>
            <mat-select
              [(ngModel)]="libro.autor"
              name="autor"
              required
              [compareWith]="compararAutores"
            >
              <mat-option *ngFor="let a of autores" [value]="a">{{
                nombreCompletoAutor(a)
              }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-12 mb-2">
          <div class="custom-file-upload">
            <input
              #fileInput
              type="file"
              (change)="onFileSelected($event)"
              hidden
            />
            <button
              mat-raised-button
              color="primary"
              (click)="fileInput.click()"
              style="margin-right: 10px"
            >
              Seleccionar Imagen
            </button>
            <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
            <button mat-raised-button color="primary" (click)="subirImagen()">
              Subir Imagen
            </button>
          </div>
          <div class="imagen-container" *ngIf="libro.portada || imagenPreview">
            <img
              [src]="'http://localhost:8080/' + imagenPreview || libro.portada"
              alt="Portada del libro"
              class="imagen-portada"
            />
          </div>
        </div>
      </form>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button mat-dialog-close>Cancelar</button>
      <button
        mat-flat-button
        color="primary"
        (click)="guardarLibro()"
        [disabled]="formLibro.invalid"
      >
        {{ editar ? "Actualizar" : "Guardar" }}
      </button>
    </mat-dialog-actions>
  </ng-template>

  <ng-template #modalDetalles let-data>
    <h2 mat-dialog-title>Detalles del Libro</h2>
    <mat-dialog-content>
      <div *ngIf="libroSelecionado?.portada">
        <img
          [src]="'http://localhost:8080/' + libroSelecionado?.portada"
          alt="Portada del libro"
          style="width: 400px; margin-top: 1rem;"
        />
      </div>

      <p><strong>Título</strong> {{ libroSelecionado?.titulo }}</p>
      <p><strong>Editorial</strong> {{ libroSelecionado?.editorial }}</p>
      <p><strong>Idioma</strong> {{ libroSelecionado?.idioma }}</p>
      <p><strong>Fecha de Publicación</strong> {{ libroSelecionado?.fechaPublicacion }}</p>
      <p><strong>Descripcion</strong> {{ libroSelecionado?.descripcion }}</p>
      <p><strong>Tipo de Pasta</strong> {{ libroSelecionado?.tipoPasta }}</p>
      <p><strong>ISBN</strong> {{ libroSelecionado?.iSBN }}</p>
      <p><strong>Presentación</strong> {{ libroSelecionado?.presentacion }}</p>
      <p><strong>Precio</strong> {{ libroSelecionado?.precio | currency }}</p>
      <p><strong>Autor</strong> 
        {{ libroSelecionado?.autor?.nombre }}
      {{ libroSelecionado?.autor?.apellido }}
    </p>
    <p><strong>Categoría:</strong>{{ libroSelecionado?.categoria?.categoria}}</p>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button (click)="cerrarModal()">Cerrar</button>
    </mat-dialog-actions>
  </ng-template>
</div>
